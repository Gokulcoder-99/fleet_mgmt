<!DOCTYPE html>
<html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
       .dashboard{
          display: flex;
          width: 100vw;
          height: 90.8vh;
       }
       .cardwidth{
        min-width: 500px;
       }
       .main{
        width: 100vw;
       }
       #value{
        display: none;
       }
       #chart{
        width: 100%;
        height: 70%;
       }
       #filter-container {
            display: flex;
            justify-content:flex-end;
            margin: 20px;
        }

        #dropdown-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light px-5">
        <div class="container-fluid">
                <a class="navbar-brand" href="#">
                  <img src="https://pbs.twimg.com/profile_images/969651847072854016/O1wofIxB_400x400.jpg" alt="" width="30" height="24" class="d-inline-block align-text-top rounded-circle">
                  Fleet Management
                </a>
              </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse float-right" id="navbarNavDropdown">
            <ul class="navbar-nav">
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Fleet
                </a>
                <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                  <li><a class="dropdown-item" href="app/new-contract-details">Contract</a></li>
                  <li><a class="dropdown-item" href="#">Services</a></li>
                </ul>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Reporting
                </a>
                <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                  <li><a class="dropdown-item" href="app/accident-details">Accident log</a></li>
                  <li><a class="dropdown-item" href="app/fuel-log">Fuel log</a></li>
                  <li><a class="dropdown-item" href="app/odometer-readings">Odometer log</a></li>
                  <li><a class="dropdown-item" href="app/fine-details">Fines log</a></li>
                </ul>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Configuration
                </a>
                <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                  <li><a class="dropdown-item" href="manufacture">Manufactures</a></li>
                </ul>
              </li>
              <li>
                <div class="dropdown">
                  <a href="#" class="d-flex align-items-center  text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                    <img src="" alt="" width="32" height="32" class="rounded-circle me-2">
                    <strong>Fleet admin</strong>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
                    <li><a class="dropdown-item" href="/">Sign out</a></li>
                  </ul>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <div class="dashboard">
        <div class="d-flex flex-column flex-shrink-0 p-3 text-white bg-dark" style="width: 280px;">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
              <svg class="bi me-2" width="40" height="32"><use xlink:href="#bootstrap"></use></svg>
              <span class="fs-4">Graphs</span>
            </a>
            <hr>
            <ul class="nav nav-pills flex-column mb-auto">
              <li class="nav-item">
                <a href="#" class="nav-link active" aria-current="page">
                  <svg class="bi me-2" width="16" height="16"><use xlink:href="#home"></use></svg>
                  Home
                </a>
              </li>
              <li>
                <a href="#" class="nav-link text-white">
                  <svg class="bi me-2" width="16" height="16"><use xlink:href="#speedometer2"></use></svg>
                  Fuel Vs Odometer
                </a>
              </li>
              <li>
                <a href="#" class="nav-link text-white">
                  <svg class="bi me-2" width="16" height="16"><use xlink:href="#table"></use></svg>
                  Fuel vs Vehicle
                </a>
              </li>
              <li>
                <a href="#" class="nav-link text-white">
                  <svg class="bi me-2" width="16" height="16"><use xlink:href="#grid"></use></svg>
                  Amount Vs Vehicle
                </a>
              </li>
            </ul>
          </div>
        <div class="main p-2">
            <div class="row">
                <div class="col-sm-6">
                  <div class="card cardwidth">
                    <div class="card-body">
                      <h5 class="card-title">Total Number Of Vehicle</h5>
                      <p class="card-text">0</p>
                      <a href="app/details-of-new-vehicles" class="btn btn-primary">List Of Vehicles</a>
                      <a href="http://127.0.0.1:8000/app/details-of-new-vehicles/new-details-of-new-vehicles-1" class="btn btn-primary">Register New Vehicle</a>
                    </div>
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="card cardwidth">
                    <div class="card-body">
                      <h5 class="card-title">Total Number Of Driver</h5>
                      <p class="card-text">0</p>
                      <a href="app/details-of-new-driver" class="btn btn-primary">List Of Driver</a>
                      <a href="http://127.0.0.1:8000/app/details-of-new-driver/new-details-of-new-driver-1" class="btn btn-primary">Register New Driver</a>
                    </div>
                  </div>
                </div>
              </div>
              <div id="value">
                {% set doc = frappe.get_all('fuel', fields=['vehicle_no','amount','fuel_in_litres','date']) %}
                {% for item in doc %}
                    {% set formatted_date = item.date.strftime('%Y-%m-%d') %}
                    {% set doc = item.update({'date': formatted_date}) %}
                {% endfor %}
                {{doc}}
            </div>
            <div id="chart">
               <div id="filter-container">
                <select id="filter-option">
                    <option value="week">Week</option>
                    <option value="day">Day</option>
                    <option value="month">Month</option>
                    <option value="year">Year</option>
                    <option value="interval">Custom Interval</option>
                </select>
                <input type="date" id="start-date" style="display: none;">
                <input type="date" id="end-date" style="display: none;">
                <button id="filter" style="display: none;">Filter</button>
            </div>
              <canvas id="myChart" width="400" height="300"></canvas>
            </div>
        </div>
      </div>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
         const value = document.getElementById('value').innerText;
        const arrayString = value.trim();
        const correctedJsonString = arrayString.replace(/'/g, '"');
        console.log(correctedJsonString)
        const data = JSON.parse(correctedJsonString)
        console.log(data)
        let myChart
        const filterOption = document.getElementById('filter-option');
        const startDate = document.getElementById('start-date');
        const endDate = document.getElementById('end-date');
        const filterButton = document.getElementById('filter');
        console.log(startDate,endDate)
        
            filterOption.value = "week"

             const today = new Date(); // Current date
                const oneWeekAgo = new Date(today);
                oneWeekAgo.setDate(today.getDate() - 7);
                const filteredData = data.filter(item => {
                  const itemDate = new Date(item.date); // Assuming 'date' is a property in your data
                  return itemDate >= oneWeekAgo && itemDate <= today;
                });
                console.log(filteredData)
                const vehicleTotals = {};
                let weeklyLabel=[]
                filteredData.forEach(entry => {
                    const vehicleNo = entry.vehicle_no;
                    const amount = entry.amount;
                    const fuelInLitres = entry.fuel_in_litres;

                    if (!vehicleTotals[vehicleNo]) {
                        weeklyLabel.push(vehicleNo)
                        vehicleTotals[vehicleNo] = {
                            total_amount: amount,
                            total_fuel_in_litres: fuelInLitres,
                        };
                    } else {
                        vehicleTotals[vehicleNo].total_amount += amount;
                        vehicleTotals[vehicleNo].total_fuel_in_litres += fuelInLitres;
                    }
                });
                const amounts = weeklyLabel.map(i=>vehicleTotals[i].total_amount);
                const fuels = weeklyLabel.map(i=>vehicleTotals[i].total_fuel_in_litres)
                console.log(amounts)
                const ctx = document.getElementById('myChart').getContext('2d');
                    // Create the bar chart
                  myChart = new Chart(ctx, {
                    type: 'bar', 
                    data: {
                      labels: weeklyLabel, 
                      datasets: [
                        {
                          label: 'fuel amount',
                          data: amounts, 
                          backgroundColor: 'blue'
                        },
                        {
                          label: 'Fine amount',
                          data: fuels,
                          backgroundColor: 'green'
                        }
                      ]
                    },
                    options: {
                      scales: {
                        y: {
                          beginAtZero: true
                        }
                      }
                    }
                  });





        filterOption.addEventListener('change', function () {
            if (filterOption.value === 'interval') {
                startDate.style.display = 'inline';
                endDate.style.display = 'inline';
                filterButton.style.display = 'inline';

            } else {
                startDate.style.display = 'none';
                endDate.style.display = 'none';
                filterButton.style.display = 'none'
              }
              const selectedFilterOption = filterOption.value;
              if (myChart) {
                  myChart.destroy();
              }
              if (selectedFilterOption === 'interval') {
                  const selectedStartDate1= new Date(startDate.value);
                  const year = selectedStartDate1.getFullYear();
                  const month = (selectedStartDate1.getMonth() + 1).toString().padStart(2, '0'); // Month is zero-based
                  const day = selectedStartDate1.getDate().toString().padStart(2, '0');

                  const selectedStartDate = `${year}-${month}-${day}`;
                  console.log(selectedStartDate)
                  const selectedEndDate1 = new Date(endDate.value);
                  const yearend = selectedEndDate1.getFullYear();
                  const monthend = (selectedEndDate1.getMonth() + 1).toString().padStart(2, '0'); // Month is zero-based
                  const dayend = selectedEndDate1.getDate().toString().padStart(2, '0');

                  const selectedEndDate = `${yearend}-${monthend}-${dayend}`;
                  const filteredData = data.filter(item => {
                  const itemDate = item.date; 
                  return (
                    itemDate >= selectedStartDate && itemDate <= selectedEndDate
                  );
                  })
                  const vehicleTotals = {};
                let yearlyLabel=[]
                filteredData.forEach(entry => {
                    const vehicleNo = entry.vehicle_no;
                    const amount = entry.amount;
                    const fuelInLitres = entry.fuel_in_litres;

                    if (!vehicleTotals[vehicleNo]) {
                        yearlyLabel.push(vehicleNo)
                        vehicleTotals[vehicleNo] = {
                            total_amount: amount,
                            total_fuel_in_litres: fuelInLitres,
                        };
                    } else {
                        vehicleTotals[vehicleNo].total_amount += amount;
                        vehicleTotals[vehicleNo].total_fuel_in_litres += fuelInLitres;
                    }
                });
                const amounts = yearlyLabel.map(i=>vehicleTotals[i].total_amount);
                const fuels = yearlyLabel.map(i=>vehicleTotals[i].total_fuel_in_litres)
                console.log(filteredData)
                const ctx = document.getElementById('myChart').getContext('2d');
                    // Create the bar chart
                  myChart = new Chart(ctx, {
                    type: 'bar', 
                    data: {
                      labels: yearlyLabel, 
                      datasets: [
                        {
                          label: 'fuel amount',
                          data: amounts, 
                          backgroundColor: 'blue'
                        },
                        {
                          label: 'Fine amount',
                          data: fuels,
                          backgroundColor: 'green'
                        }
                      ]
                    },
                    options: {
                      scales: {
                        y: {
                          beginAtZero: true
                        }
                      }
                    }
                  });
                }else if(selectedFilterOption === 'day'){
                const selectedDate = new Date(); // Replace with your selected date
                const filteredData = data.filter(item => {
                  const itemDate = new Date(item.date); // Assuming 'date' is a property in your data
                  return (
                    itemDate.getDate() === selectedDate.getDate() &&
                    itemDate.getMonth() === selectedDate.getMonth() &&
                    itemDate.getFullYear() === selectedDate.getFullYear()
                  );
                });
                console.log(filteredData)
                const vehicleTotals = {};
                let dailyLabel=[]
                filteredData.forEach(entry => {
                    const vehicleNo = entry.vehicle_no;
                    const amount = entry.amount;
                    const fuelInLitres = entry.fuel_in_litres;

                    if (!vehicleTotals[vehicleNo]) {
                        dailyLabel.push(vehicleNo)
                        vehicleTotals[vehicleNo] = {
                            total_amount: amount,
                            total_fuel_in_litres: fuelInLitres,
                        };
                    } else {
                        vehicleTotals[vehicleNo].total_amount += amount;
                        vehicleTotals[vehicleNo].total_fuel_in_litres += fuelInLitres;
                    }
                });
                const amounts = dailyLabel.map(i=>vehicleTotals[i].total_amount);
                const fuels = dailyLabel.map(i=>vehicleTotals[i].total_fuel_in_litres)
                console.log(amounts)
                const ctx = document.getElementById('myChart').getContext('2d');
                    // Create the bar chart
                   myChart = new Chart(ctx, {
                    type: 'bar', 
                    data: {
                      labels: dailyLabel, 
                      datasets: [
                        {
                          label: 'fuel amount',
                          data: amounts, 
                          backgroundColor: 'blue'
                        },
                        {
                          label: 'Fine amount',
                          data: fuels,
                          backgroundColor: 'green'
                        }
                      ]
                    },
                    options: {
                      scales: {
                        y: {
                          beginAtZero: true
                        }
                      }
                    }
                  });
                
              }else if(selectedFilterOption === 'week'){
                const today = new Date(); // Current date
                const oneWeekAgo = new Date(today);
                oneWeekAgo.setDate(today.getDate() - 7);
                const filteredData = data.filter(item => {
                  const itemDate = new Date(item.date); // Assuming 'date' is a property in your data
                  return itemDate >= oneWeekAgo && itemDate <= today;
                });
                console.log(filteredData)
                const vehicleTotals = {};
                let weeklyLabel=[]
                filteredData.forEach(entry => {
                    const vehicleNo = entry.vehicle_no;
                    const amount = entry.amount;
                    const fuelInLitres = entry.fuel_in_litres;

                    if (!vehicleTotals[vehicleNo]) {
                        weeklyLabel.push(vehicleNo)
                        vehicleTotals[vehicleNo] = {
                            total_amount: amount,
                            total_fuel_in_litres: fuelInLitres,
                        };
                    } else {
                        vehicleTotals[vehicleNo].total_amount += amount;
                        vehicleTotals[vehicleNo].total_fuel_in_litres += fuelInLitres;
                    }
                });
                const amounts = weeklyLabel.map(i=>vehicleTotals[i].total_amount);
                const fuels = weeklyLabel.map(i=>vehicleTotals[i].total_fuel_in_litres)
                console.log(amounts)
                const ctx = document.getElementById('myChart').getContext('2d');
                    // Create the bar chart
                  myChart = new Chart(ctx, {
                    type: 'bar', 
                    data: {
                      labels: weeklyLabel, 
                      datasets: [
                        {
                          label: 'fuel amount',
                          data: amounts, 
                          backgroundColor: 'blue'
                        },
                        {
                          label: 'Fine amount',
                          data: fuels,
                          backgroundColor: 'green'
                        }
                      ]
                    },
                    options: {
                      scales: {
                        y: {
                          beginAtZero: true
                        }
                      }
                    }
                  });
      
              }else if(selectedFilterOption === 'month'){
                const today = new Date(); // Current date
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                const filteredData = data.filter(item => {
                  const itemDate = new Date(item.date); // Assuming 'date' is a property in your data
                  return itemDate >= startOfMonth && itemDate <= endOfMonth;
                });
                const vehicleTotals = {};
                let monthlyLabel=[]
                filteredData.forEach(entry => {
                    const vehicleNo = entry.vehicle_no;
                    const amount = entry.amount;
                    const fuelInLitres = entry.fuel_in_litres;

                    if (!vehicleTotals[vehicleNo]) {
                        monthlyLabel.push(vehicleNo)
                        vehicleTotals[vehicleNo] = {
                            total_amount: amount,
                            total_fuel_in_litres: fuelInLitres,
                        };
                    } else {
                        vehicleTotals[vehicleNo].total_amount += amount;
                        vehicleTotals[vehicleNo].total_fuel_in_litres += fuelInLitres;
                    }
                });
                const amounts = monthlyLabel.map(i=>vehicleTotals[i].total_amount);
                const fuels = monthlyLabel.map(i=>vehicleTotals[i].total_fuel_in_litres)
                console.log(amounts)
                const ctx = document.getElementById('myChart').getContext('2d');
                    // Create the bar chart
                  myChart = new Chart(ctx, {
                    type: 'bar', 
                    data: {
                      labels: monthlyLabel, 
                      datasets: [
                        {
                          label: 'fuel amount',
                          data: amounts, 
                          backgroundColor: 'blue'
                        },
                        {
                          label: 'Fine amount',
                          data: fuels,
                          backgroundColor: 'green'
                        }
                      ]
                    },
                    options: {
                      scales: {
                        y: {
                          beginAtZero: true
                        }
                      }
                    }
                  });
              }else{
                const today = new Date(); // Current date
                const startOfYear = new Date(today.getFullYear(), 0, 1);
                const endOfYear = new Date(today.getFullYear(), 11, 31);
                const filteredData = data.filter(item => {
                  const itemDate = new Date(item.date); // Assuming 'date' is a property in your data
                  return itemDate >= startOfYear && itemDate <= endOfYear;
                });
                const vehicleTotals = {};
                let yearlyLabel=[]
                filteredData.forEach(entry => {
                    const vehicleNo = entry.vehicle_no;
                    const amount = entry.amount;
                    const fuelInLitres = entry.fuel_in_litres;

                    if (!vehicleTotals[vehicleNo]) {
                        yearlyLabel.push(vehicleNo)
                        vehicleTotals[vehicleNo] = {
                            total_amount: amount,
                            total_fuel_in_litres: fuelInLitres,
                        };
                    } else {
                        vehicleTotals[vehicleNo].total_amount += amount;
                        vehicleTotals[vehicleNo].total_fuel_in_litres += fuelInLitres;
                    }
                });
                const amounts = yearlyLabel.map(i=>vehicleTotals[i].total_amount);
                const fuels = yearlyLabel.map(i=>vehicleTotals[i].total_fuel_in_litres)
                console.log(amounts)
                const ctx = document.getElementById('myChart').getContext('2d');
                    // Create the bar chart
                  myChart = new Chart(ctx, {
                    type: 'bar', 
                    data: {
                      labels: yearlyLabel, 
                      datasets: [
                        {
                          label: 'fuel amount',
                          data: amounts, 
                          backgroundColor: 'blue'
                        },
                        {
                          label: 'Fine amount',
                          data: fuels,
                          backgroundColor: 'green'
                        }
                      ]
                    },
                    options: {
                      scales: {
                        y: {
                          beginAtZero: true
                        }
                      }
                    }
                  });
              }
        });

        filterButton.addEventListener('click', function () {
          const selectedFilterOption = filterOption.value;
              if (myChart) {
                  myChart.destroy();
              }
              if (selectedFilterOption === 'interval') {
                  const selectedStartDate1= new Date(startDate.value);
                  const year = selectedStartDate1.getFullYear();
                  const month = (selectedStartDate1.getMonth() + 1).toString().padStart(2, '0'); // Month is zero-based
                  const day = selectedStartDate1.getDate().toString().padStart(2, '0');

                  const selectedStartDate = `${year}-${month}-${day}`;
                  console.log(selectedStartDate)
                  const selectedEndDate1 = new Date(endDate.value);
                  const yearend = selectedEndDate1.getFullYear();
                  const monthend = (selectedEndDate1.getMonth() + 1).toString().padStart(2, '0'); // Month is zero-based
                  const dayend = selectedEndDate1.getDate().toString().padStart(2, '0');

                  const selectedEndDate = `${yearend}-${monthend}-${dayend}`;
                  const filteredData = data.filter(item => {
                  const itemDate = item.date; 
                  return (
                    itemDate >= selectedStartDate && itemDate <= selectedEndDate
                  );
                  })
                  const vehicleTotals = {};
                let yearlyLabel=[]
                filteredData.forEach(entry => {
                    const vehicleNo = entry.vehicle_no;
                    const amount = entry.amount;
                    const fuelInLitres = entry.fuel_in_litres;

                    if (!vehicleTotals[vehicleNo]) {
                        yearlyLabel.push(vehicleNo)
                        vehicleTotals[vehicleNo] = {
                            total_amount: amount,
                            total_fuel_in_litres: fuelInLitres,
                        };
                    } else {
                        vehicleTotals[vehicleNo].total_amount += amount;
                        vehicleTotals[vehicleNo].total_fuel_in_litres += fuelInLitres;
                    }
                });
                const amounts = yearlyLabel.map(i=>vehicleTotals[i].total_amount);
                const fuels = yearlyLabel.map(i=>vehicleTotals[i].total_fuel_in_litres)
                console.log(filteredData)
                const ctx = document.getElementById('myChart').getContext('2d');
                    // Create the bar chart
                  myChart = new Chart(ctx, {
                    type: 'bar', 
                    data: {
                      labels: yearlyLabel, 
                      datasets: [
                        {
                          label: 'fuel amount',
                          data: amounts, 
                          backgroundColor: 'blue'
                        },
                        {
                          label: 'Fine amount',
                          data: fuels,
                          backgroundColor: 'green'
                        }
                      ]
                    },
                    options: {
                      scales: {
                        y: {
                          beginAtZero: true
                        }
                      }
                    }
                  });
                }
          
        });
       
      </script>
      
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</body>
</html>
